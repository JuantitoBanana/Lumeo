spring.application.name=lumeo

# Configurar servidor para escuchar en todas las interfaces
server.address=0.0.0.0
server.port=${PORT:8080}

# Configuración de base de datos usando variables de entorno
spring.datasource.url=${DATABASE_URL:jdbc:postgresql://localhost:5432/postgres}
spring.datasource.username=${DATABASE_USERNAME:postgres}
spring.datasource.password=${DATABASE_PASSWORD:password}
spring.datasource.driver-class-name=org.postgresql.Driver

# Hibernate Configuration - Optimizado para Supabase Transaction Pooler (Puerto 6543)
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.properties.hibernate.use_sql_comments=false
# CRÍTICO: Configuración mínima para Transaction Pooler
spring.jpa.properties.hibernate.jdbc.batch_size=0
spring.jpa.properties.hibernate.order_inserts=false
spring.jpa.properties.hibernate.order_updates=false
# Cache mínimo permitido por Hibernate (no puede ser 0)
spring.jpa.properties.hibernate.query.plan_cache_max_size=32
spring.jpa.properties.hibernate.query.plan_parameter_metadata_max_size=16

# Connection pool settings - MODO DIAGNÓSTICO
# Usando 1 sola conexión para evitar agotar el límite
spring.datasource.hikari.maximum-pool-size=1
spring.datasource.hikari.minimum-idle=0
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.validation-timeout=5000
# Lifecycle: Conexiones efímeras
spring.datasource.hikari.max-lifetime=300000
spring.datasource.hikari.idle-timeout=60000
spring.datasource.hikari.keepalive-time=0
spring.datasource.hikari.leak-detection-threshold=30000
# Pool naming
spring.datasource.hikari.pool-name=LumeoHikariCP
# Connection test query
spring.datasource.hikari.connection-test-query=SELECT 1
# Reintentos de conexión
spring.datasource.hikari.initialization-fail-timeout=-1

# Configuración para Transaction Pooler (Puerto 6543)
# Transaction Pooler NO SOPORTA prepared statements ni estado de sesión
# Cada transacción puede usar una conexión diferente del pool
# Soporta hasta 200 conexiones concurrentes

# Configuración de transacciones - Optimizado para Transaction Pooler
spring.transaction.default-timeout=30
spring.jpa.properties.hibernate.connection.autocommit=true
spring.jpa.properties.hibernate.connection.provider_disables_autocommit=false
spring.jpa.properties.hibernate.jdbc.use_get_generated_keys=true

# Configuración adicional para estabilidad
spring.sql.init.continue-on-error=false
spring.jpa.open-in-view=false
# Auto-commit habilitado para Session Pooler
spring.datasource.hikari.auto-commit=true

# Actuator Health Check Configuration
management.endpoints.web.exposure.include=health
management.endpoint.health.show-details=always
management.health.defaults.enabled=true
# DESHABILITADO: health check de DB consume conexiones extras
management.health.db.enabled=false